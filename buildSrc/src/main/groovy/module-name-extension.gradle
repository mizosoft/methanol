import com.github.javaparser.JavaParser
import com.github.javaparser.ParserConfiguration

static def getModuleExtensionName(String sourceSetName) {
  return sourceSetName == 'main' ? "javaModuleName" : "${sourceSetName}JavaModuleName"
}

sourceSets.each { sourceSet ->
  sourceSet.allJava.filter { File file -> file.name == 'module-info.java' }.files.stream().findFirst()
      .ifPresent { moduleInfoFile ->
        def parser = new JavaParser()
        parser.getParserConfiguration().setLanguageLevel(ParserConfiguration.LanguageLevel.JAVA_11)
        parser.parse(moduleInfoFile.toPath()).result.flatMap { it.module }.map { it.name as String }
            .ifPresent { moduleName ->
              extensions.add(String.class, getModuleExtensionName(sourceSet.name), moduleName)
            }
      }
}
